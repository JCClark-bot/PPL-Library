{
  "$schema": "http://json-schema.org/draft/2020-12/schema",
  "title": "Process Protocol Layer (PPL) Schema v2.4",
  "type": "object",
  "required": ["process", "inputs", "preconditions", "activity", "outputs", "approvals"],

  "$defs": {
    "MetricSpec": {
      "type": "object",
      "properties": {
        "target": { "type": "number" },
        "alert_over": { "type": "number" },
        "alert_under": { "type": "number" }
      },
      "additionalProperties": false
    },
    "MetricsMap": {
      "type": "object",
      "additionalProperties": { "$ref": "#/$defs/MetricSpec" }
    },
    "BiasChecks": {
      "type": "object",
      "properties": {
        "applies_to": { "type": "array", "items": { "type": "string" } },
        "countermeasures": { "type": "array", "items": { "type": "string" } }
      },
      "additionalProperties": false
    },
    "Controls": {
      "type": "object",
      "properties": {
        "human_in_loop": { "type": "boolean" },
        "segregation_of_duties": { "type": "array", "items": { "type": "string" } }
      },
      "additionalProperties": false
    },
    "Overlays": {
      "type": "object",
      "description": "Optional overlays that modify or clarify the process or an element",
      "properties": {
        "values": {
          "type": "array",
          "items": {
            "oneOf": [
              { "type": "string" },
              {
                "type": "object",
                "required": ["name"],
                "properties": {
                  "name": { "type": "string" },
                  "ref": { "type": "string", "description": "Document/URL reference" }
                },
                "additionalProperties": false
              }
            ]
          }
        },
        "metrics": { "$ref": "#/$defs/MetricsMap" },
        "bias_checks": { "$ref": "#/$defs/BiasChecks" },
        "controls": { "$ref": "#/$defs/Controls" }
      },
      "additionalProperties": false
    },

    "Verification": {
      "type": "object",
      "properties": {
        "method": { "type": "string" },
        "required": { "type": "boolean" }
      },
      "additionalProperties": false
    },

    "DeploymentMapping": {
      "type": "object",
      "properties": {
        "system": { "type": "string" },
        "environment": { "type": "string" }
      },
      "additionalProperties": false
    },

    "DecisionArtifact": {
      "oneOf": [
        { "type": "string" },
        {
          "type": "object",
          "required": ["name"],
          "properties": {
            "name": { "type": "string" },
            "ref": { "type": "string", "description": "Document/URL reference" }
          },
          "additionalProperties": false
        }
      ]
    },

    "Recordkeeping": {
      "type": "object",
      "description": "Optional routing/retention/policy overrides; engine always audit-logs by default.",
      "properties": {
        "destination": { "type": "string", "description": "Storage path/URI (SharePoint, S3, QMS area, etc.)" },
        "format": { "type": "string", "description": "Expected artifact format (PDF, JSON, CSV, etc.)" },
        "retention": { "type": "string", "description": "e.g., 5 years" },
        "policy_ref": { "type": "string", "description": "SOP/Policy reference" }
      },
      "additionalProperties": false
    },

    "Dispatch": {
      "type": "object",
      "description": "Send a generated record/package somewhere when an element completes.",
      "required": ["destination"],
      "properties": {
        "destination": { "type": "string", "description": "Target system/URI/email queue, etc." },
        "format": { "type": "string", "description": "Payload format to send (PDF, JSON, ZIP, msgpack)" },
        "template_ref": { "type": "string", "description": "Optional template/renderer reference" },
        "include": {
          "type": "object",
          "description": "Selectors for what to include in the payload",
          "properties": {
            "inputs": { "type": "boolean" },
            "outputs": { "type": "boolean" },
            "approvals": { "type": "boolean" },
            "activity_state": { "type": "boolean" },
            "evidence_pack": { "type": "boolean" }
          },
          "additionalProperties": false
        },
        "sign": { "type": "boolean", "description": "Digitally sign payload before dispatch" },
        "encrypt": { "type": "boolean", "description": "Encrypt payload at rest/in transit" },
        "when": {
          "type": "string",
          "enum": ["on_activity_complete", "on_step_complete", "on_process_complete", "manual"],
          "default": "on_activity_complete"
        },
        "metadata": { "type": "object", "additionalProperties": true }
      },
      "additionalProperties": false
    },

    "ProcessDependency": {
      "type": "object",
      "description": "Reference to another process whose state gates this process/element.",
      "properties": {
        "process_id": { "type": "string", "description": "Target process definition id (URN/UUID/URI)" },
        "instance_id": { "type": "string", "description": "Optional specific execution instance id" },
        "required_state": {
          "type": "string",
          "enum": ["completed", "succeeded"],
          "default": "completed"
        },
        "version_constraint": {
          "type": "string",
          "description": "Optional semver/regex constraint, e.g. '>=2.0 <3.0'"
        },
        "window": {
          "type": "object",
          "description": "Optional temporal window the dependency must satisfy",
          "properties": {
            "not_before": { "type": "string", "format": "date-time" },
            "not_after": { "type": "string", "format": "date-time" },
            "within": { "type": "string", "description": "ISO 8601 duration, e.g. 'P7D'" }
          },
          "additionalProperties": false
        },
        "metadata": { "type": "object", "additionalProperties": true }
      },
      "required": ["process_id"],
      "additionalProperties": false
    },

    "GuardSpec": {
      "type": "object",
      "description": "Step-level gates evaluated at runtime.",
      "properties": {
        "preconditions": {
          "type": "array",
          "items": { "type": "string", "description": "Boolean expression or policy reference." }
        },
        "inputs_required": {
          "type": "array",
          "items": { "type": "string", "description": "Names/paths of required inputs." }
        }
      },
      "additionalProperties": false
    },

    "PartitionSpec": {
      "type": "object",
      "description": "Controls per-item or batched execution over lists.",
      "properties": {
        "mode": { "type": "string", "enum": ["none", "per-item", "batch"], "default": "none" },
        "input_path": { "type": "string", "description": "JSON Pointer/Path to the list to iterate." },
        "batch_size": { "type": "integer", "minimum": 1 },
        "concurrency": { "type": "integer", "minimum": 1, "description": "Max parallel workers." }
      },
      "additionalProperties": false
    },

    "AggregationSpec": {
      "type": "object",
      "description": "How to merge parallel outputs.",
      "properties": {
        "method": { "type": "string", "enum": ["concat", "merge", "reduce", "vote"], "default": "concat" },
        "key": { "type": "string", "description": "Optional key for reduce/merge." },
        "script_ref": { "type": "string", "description": "Optional custom reducer reference." },
        "output": { "type": "string", "description": "Name of aggregated output variable." }
      },
      "additionalProperties": false
    },

    "SubprocessCall": {
      "type": "object",
      "description": "Execute another PPL-defined process as part of this step.",
      "properties": {
        "process_ref": { "type": "string", "description": "Target process id/URN/URI." },
        "version_constraint": { "type": "string", "description": "e.g., '>=1.0 <2.0'." },
        "mode": { "type": "string", "enum": ["sync", "spawn"], "default": "sync" },
        "map_inputs": {
          "type": "object",
          "description": "Mapping from parent vars to callee inputs.",
          "additionalProperties": true
        },
        "map_outputs": {
          "type": "object",
          "description": "Mapping from callee outputs to parent vars.",
          "additionalProperties": true
        }
      },
      "required": ["process_ref"],
      "additionalProperties": false
    },

    "AuditInput": {
      "type": "object",
      "description": "Shape of input entries the engine writes to the audit log",
      "properties": {
        "event": { "type": "string", "const": "input_attached" },
        "ts": { "type": "string", "format": "date-time" },
        "process_id": { "type": "string" },
        "element": { "type": "string", "description": "e.g., inputs[1]" },
        "input": {
          "type": "object",
          "properties": {
            "input_id": { "type": "string" },
            "name": { "type": "string" },
            "source_system": { "type": "string" },
            "uri": { "type": "string" },
            "mime": { "type": "string" },
            "size_bytes": { "type": "integer" },
            "sha256": { "type": "string" },
            "encryption": { "type": "string" },
            "retention": { "type": "string" },
            "tags": { "type": "array", "items": { "type": "string" } },
            "embedded": { "type": "boolean" }
          },
          "required": ["name", "sha256"],
          "additionalProperties": true
        }
      },
      "required": ["event", "ts", "element", "input"],
      "additionalProperties": true
    },

    "EngineInputLogging": {
      "type": "object",
      "properties": {
        "mode": { "type": "string", "enum": ["pointer", "embed", "hybrid"], "default": "pointer" },
        "embed_max_bytes": { "type": "integer", "default": 2000000 },
        "embed_mime_allowlist": { "type": "array", "items": { "type": "string" } },
        "sensitive_field_denylist": { "type": "array", "items": { "type": "string" } },
        "redact_patterns": { "type": "array", "items": { "type": "string" } },
        "encryption": { "type": "string" },
        "retention_default": { "type": "string" }
      },
      "additionalProperties": false
    },

    "ElementCommon": {
      "type": "object",
      "properties": {
        "description": { "type": "string" },
        "overlays": { "$ref": "#/$defs/Overlays" },
        "decision_artifacts": { "type": "array", "items": { "$ref": "#/$defs/DecisionArtifact" } },
        "verification": { "$ref": "#/$defs/Verification" },
        "deployment": { "$ref": "#/$defs/DeploymentMapping" },
        "recordkeeping": { "$ref": "#/$defs/Recordkeeping" },
        "dispatch": { "$ref": "#/$defs/Dispatch" },
        "metadata": { "type": "object", "additionalProperties": true },
        "runtime_hints": {
          "type": "object",
          "description": "Optional, non-portable hints for runtimes/interpreters. Use namespaced keys like 'x-n8n', 'x-airflow', 'x-agents'.",
          "additionalProperties": true
        }
      },
      "additionalProperties": false
    },

    "InputItem": {
      "oneOf": [
        { "type": "string" },
        {
          "allOf": [
            { "$ref": "#/$defs/ElementCommon" },
            {
              "type": "object",
              "required": ["name"],
              "properties": {
                "name": { "type": "string" },
                "source": { "type": "string", "description": "Where this input comes from" }
              },
              "additionalProperties": false
            }
          ]
        }
      ]
    },

    "PreconditionItem": {
      "oneOf": [
        { "type": "string" },
        {
          "allOf": [
            { "$ref": "#/$defs/ElementCommon" },
            {
              "type": "object",
              "properties": {
                "condition": { "type": "string" },
                "depends_on_process": { "$ref": "#/$defs/ProcessDependency" }
              },
              "anyOf": [
                { "required": ["condition"] },
                { "required": ["depends_on_process"] }
              ],
              "additionalProperties": false
            }
          ]
        }
      ]
    },

    "ActivityItem": {
      "oneOf": [
        { "type": "string" },
        {
          "allOf": [
            { "$ref": "#/$defs/ElementCommon" },
            {
              "type": "object",
              "properties": {
                "sequence_model": {
                  "type": "string",
                  "enum": ["sequential", "parallel", "dag"],
                  "default": "dag",
                  "description": "How to interpret steps (explicit order, all parallel, or DAG via depends_on)."
                },
                "steps": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "required": ["name"],
                    "properties": {
                      "id": { "type": "string", "description": "Unique within activity; used by depends_on" },
                      "name": { "type": "string" },
                      "type": {
                        "type": "string",
                        "enum": [
                          "ai.task",
                          "system.http",
                          "data.transform",
                          "human.task",
                          "subprocess.call",
                          "wait.event",
                          "decision"
                        ],
                        "description": "Semantic step type."
                      },
                      "instruction": { "type": "string" },
                      "sequence": { "type": "integer", "description": "Optional explicit order index" },
                      "depends_on": {
                        "type": "array",
                        "description": "List of step ids that must complete before this step",
                        "items": { "type": "string" }
                      },
                      "critical": { "type": "boolean", "description": "Marks this step as critical path candidate" },
                      "time_estimate_minutes": { "type": "number" },
                      "earliest_start_offset": { "type": "string", "description": "ISO 8601 duration from activity start" },
                      "latest_finish_offset": { "type": "string", "description": "ISO 8601 duration from activity start" },

                      "inputs_map": {
                        "type": "object",
                        "description": "Name→JSON Pointer/Path from process context into this step.",
                        "additionalProperties": true
                      },
                      "outputs_map": {
                        "type": "object",
                        "description": "Name→JSON Pointer/Path from this step back into process context.",
                        "additionalProperties": true
                      },

                      "guards": { "$ref": "#/$defs/GuardSpec" },
                      "partition": { "$ref": "#/$defs/PartitionSpec" },
                      "aggregation": { "$ref": "#/$defs/AggregationSpec" },
                      "subprocess": { "$ref": "#/$defs/SubprocessCall" },

                      "overlays": { "$ref": "#/$defs/Overlays" },
                      "decision_artifacts": { "type": "array", "items": { "$ref": "#/$defs/DecisionArtifact" } },
                      "verification": { "$ref": "#/$defs/Verification" },
                      "deployment": { "$ref": "#/$defs/DeploymentMapping" },
                      "recordkeeping": { "$ref": "#/$defs/Recordkeeping" },
                      "dispatch": { "$ref": "#/$defs/Dispatch" },
                      "metadata": { "type": "object", "additionalProperties": true },
                      "runtime_hints": {
                        "type": "object",
                        "description": "Optional, non-portable hints for runtimes/interpreters. Use namespaced keys like 'x-n8n', 'x-airflow', 'x-agents'.",
                        "additionalProperties": true
                      }
                    },
                    "additionalProperties": false
                  }
                }
              },
              "additionalProperties": false
            }
          ]
        }
      ]
    },

    "OutputItem": {
      "oneOf": [
        { "type": "string" },
        {
          "allOf": [
            { "$ref": "#/$defs/ElementCommon" },
            {
              "type": "object",
              "required": ["name"],
              "properties": {
                "name": { "type": "string" },
                "destination": { "type": "string", "description": "Where this output is stored/sent" }
              },
              "additionalProperties": false
            }
          ]
        }
      ]
    },

    "Approval": {
      "type": "object",
      "required": ["type"],
      "properties": {
        "type": { "type": "string" },
        "required": { "type": "boolean" },
        "actor": { "type": "string", "description": "Who approves (human, system, role)" },
        "applies_to": {
          "type": "array",
          "description": "Optional element targets (e.g., 'activity', 'outputs[0]')",
          "items": { "type": "string" }
        },
        "method": {
          "type": "string",
          "enum": ["e_signature", "click_to_approve", "verbal_with_witness", "system_auto_gate"],
          "description": "How the approval is executed"
        },
        "recordkeeping": { "$ref": "#/$defs/Recordkeeping" },
        "verification": { "$ref": "#/$defs/Verification" },
        "deployment": { "$ref": "#/$defs/DeploymentMapping" },
        "evidence": {
          "type": "object",
          "description": "Runtime-populated by the engine",
          "properties": {
            "approval_id": { "type": "string" },
            "signed_at": { "type": "string", "format": "date-time" },
            "signer_id": { "type": "string" },
            "signature_type": { "type": "string" },
            "signature_ref": { "type": "string" },
            "audit_log_id": { "type": "string" },
            "hash": { "type": "string" },
            "certificate_chain_ref": { "type": "string" }
          },
          "additionalProperties": true
        },
        "metadata": { "type": "object", "additionalProperties": true }
      },
      "additionalProperties": false
    },

    "Transition": {
      "type": "object",
      "properties": {
        "to_process": { "type": "string" },
        "condition": { "type": "string" }
      },
      "additionalProperties": false
    }
  },

  "properties": {
    "process": { "type": "string", "description": "Human-readable process name" },
    "process_id": { "type": "string", "description": "Stable unique identifier for this process (URN/UUID/URI)" },
    "instance_id": { "type": "string", "description": "Optional runtime execution id (set by engine)" },
    "version": { "type": "string", "description": "Schema or process version (e.g. 2.4.0)" },

    "dependencies": {
      "type": "array",
      "description": "Other processes that must meet a state before this process can start or proceed.",
      "items": { "$ref": "#/$defs/ProcessDependency" }
    },

    "inputs": {
      "type": "array",
      "description": "Data, documents, or materials required to begin",
      "items": { "$ref": "#/$defs/InputItem" }
    },

    "preconditions": {
      "type": "array",
      "description": "Conditions that must be true before the process starts (or dependencies on other processes)",
      "items": { "$ref": "#/$defs/PreconditionItem" }
    },

    "activity": {
      "description": "The action to be performed (optionally composed of sequenced/DAG steps)",
      "$ref": "#/$defs/ActivityItem"
    },

    "outputs": {
      "type": "array",
      "description": "Expected results of the activity",
      "items": { "$ref": "#/$defs/OutputItem" }
    },

    "approvals": {
      "type": "array",
      "description": "Verification or sign-off steps",
      "items": { "$ref": "#/$defs/Approval" }
    },

    "overlays": { "$ref": "#/$defs/Overlays" },

    "decision_artifacts": {
      "type": "array",
      "description": "Global documents/data used to guide decisions",
      "items": { "$ref": "#/$defs/DecisionArtifact" }
    },

    "verification": {
      "description": "Global verification applied to the overall outcome",
      "$ref": "#/$defs/Verification"
    },

    "deployment_profile": {
      "description": "Global mapping to systems/environments",
      "$ref": "#/$defs/DeploymentMapping"
    },

    "dispatch": {
      "$ref": "#/$defs/Dispatch",
      "description": "Optional process-level dispatch (e.g., final evidence pack)"
    },

    "transitions": {
      "type": "array",
      "description": "Links to next processes or states",
      "items": { "$ref": "#/$defs/Transition" }
    },

    "engine_config": {
      "type": "object",
      "description": "Execution Engine knobs (doc-only; not enforced by JSON Schema tooling).",
      "properties": {
        "log_inputs": { "$ref": "#/$defs/EngineInputLogging" }
      },
      "additionalProperties": true
    },

    "metadata": {
      "type": "object",
      "description": "Optional metadata for traceability",
      "properties": {
        "owner": { "type": "string" },
        "created_at": { "type": "string", "format": "date-time" },
        "tags": { "type": "array", "items": { "type": "string" } }
      },
      "additionalProperties": false
    },

    "runtime_hints": {
      "type": "object",
      "description": "Optional, non-portable hints for runtimes/interpreters. Use namespaced keys like 'x-n8n', 'x-airflow', 'x-agents'.",
      "additionalProperties": true
    }
  },

  "additionalProperties": false
}
